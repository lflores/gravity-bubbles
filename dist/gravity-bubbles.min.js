/**!
 * gravity-bubbles
 * Animated bubbles chart with gravity
 *
 * @license 
 * @author Leonardo Flores <flores.leonardo@gmail.com> (http://www.triadsoft.com.ar)
 * @version 0.0.5
 **/
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a["gravity-bubbles"]=b()}):"object"==typeof exports?module.exports=b():a["gravity-bubbles"]=b()}(this,function(){return GravityBubbles=function(a){this.margin={top:3,right:3,bottom:3,left:3};var b={sticky:!1,height:600,width:350,minRadius:5,maxRadius:40,debug:!1,lanes:3,points:[0,15,20,40,100],colors:["#d84b2a","#beccae","#7aa25c","#7aa25c"],id:"treemap",colorById:"gp_brl",sizeById:"ns_brl",showChild:!1,groupById:"all",data:{labels:{label:"{description}",formatter:d3.format(",.2f")},tooltip:{template:"<b>{name} - {description}</b><br><b>GP %:</b>{gp_brl} <br><b>GTN %:</b> {gtn_brl}<br><b>NS:</b> {ns_brl}",formatter:d3.format(",.2f")},group:{label:function(a,b){return"all"===b._config.groupById?"":"color"===b._config.groupById?"more"===a.key?"> "+b._config.points[b._config.points.length-1]:"<= "+a.key:a.key}},onclick:function(a,b){}},legend:{format:function(a){return d3.format(",.2f")(a)}}};this._config=$.extend(!0,b,a),this.tooltip=CustomTooltip("bubble_tooltip",240),this.create()},GravityBubbles.prototype.create=function(){this.container=d3.select("#"+this._config.id),this.container.style("overflow","hidden"),this.svg=this.container.append("svg").attr("class","map-container").attr("width",this._config.width).attr("height",this._config.height),this.svg.append("g").attr("id","groups_layer"),this.svg.append("g").attr("id","bubbles_layer"),this.svg.append("g").attr("id","legend_layer"),this.svg.append("g").attr("id","groups_title_layer"),this.center={x:this._config.width/2,y:this._config.height/2},this.layout_gravity=-.1,this.damper=.1,this.nodes=[],this.force=null,this.circles=null,this.fill_color=d3.scale.linear().domain(this._config.points).range(this._config.colors),this.radius_scale=d3.scale.pow().exponent(.5).range([this._config.minRadius,this._config.maxRadius])},GravityBubbles.prototype.config=function(a){this._config=$.extend(!0,this._config,a),this._update_colors(),this.svg.attr("width",this._config.width).attr("height",this._config.height),this.force&&this.force.size([this._config.width,this._config.height]),this._update_radius(),this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount],this.center={x:this._config.width/2,y:this._config.height/2},this.refresh()},GravityBubbles.prototype.update_details=function(a,b,c){return this.tooltip.updatePosition(c)},GravityBubbles.prototype.show_details=function(a,b,c){var d="";return"string"==typeof c._config.data.tooltip?d=c._data_replace(a,c._config.data.tooltip):"function"==typeof c._config.data.tooltip?(d=c._config.data.tooltip.call(c,a),d=c._data_replace(a,d)):"object"==typeof c._config.data.tooltip&&"string"==typeof c._config.data.tooltip.template?d=c._data_replace(a,c._config.data.tooltip.template,c._config.data.tooltip.formatter):"object"==typeof c._config.data.tooltip&&"function"==typeof c._config.data.tooltip.template&&(d=c._data_replace(a,c._config.data.tooltip.template.call(a,b,c),c._config.data.tooltip.formatter)),this.tooltip.showTooltip(d,d3.event)},GravityBubbles.prototype.hide_details=function(a,b,c){return this.tooltip.hideTooltip()},GravityBubbles.prototype._data_replace=function(a,b,c){b=b?b.slice(0):this._config.template,"undefined"==typeof c&&(c=d3.format(",.2f"));var d=b.match(/{([\w\.\_\/]+)}/g);return d&&$.each(d,function(d,e){var f=/{([\w\.\_\/]+)}/g.exec(e),g="";a.hasOwnProperty(f[1])&&"id"!=f[1]&&"name"!=f[1]&&"description"!=f[1]?g=isNaN(Number(a[f[1]]))?a[f[1]]:c(a[f[1]],f[1]):a.hasOwnProperty(f[1])&&(g=isNaN(Number(a[f[1]]))?a[f[1]]:""+Number(a[f[1]])),b=b.replace(e,g)}),b},GravityBubbles.prototype.colors=function(a){this._config.colors=a,this._update_colors(),this.refresh()},GravityBubbles.prototype.points=function(a){this._config.points=a,this._update_colors(),this._calculate_groups(),this.refresh(),this.force.start()},GravityBubbles.prototype.colorById=function(a){this._config.colorById=a,this._update_colors(),this._calculate_groups(),this.refresh(),this.force.start()},GravityBubbles.prototype.sizeById=function(a){var b=this;this._config.sizeById=a,this.min_amount=d3.min(this._data,function(a){return Number(a[b._config.sizeById])}),this.max_amount=d3.max(this._data,function(a){return Number(a[b._config.sizeById])}),this.nodes=this.nodes.sort(function(a,c){return c[b._config.sizeById]-a[b._config.sizeById]}),this._update_radius(),this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount],this.config({sizeById:a}),this.refresh(),this.force.start()},GravityBubbles.prototype.groupById=function(a){this._config.groupById=a&&0!==a.length?a:"all";this._calculate_groups(),this.refresh(),this.force.start()},GravityBubbles.prototype._calculate_color_group=function(a){var b=this,c=[];b._config.points.forEach(function(a,b){var d=""+a;c.push(d)}),this.group_scale=d3.scale.threshold().domain(b._config.points).range(c);var d=isNaN(Number(a[b._config.colorById]))?0:Number(a[b._config.colorById]),e=this.group_scale(d);return"undefined"==typeof e?"more":e},GravityBubbles.prototype._calculate_groups=function(){var a=this;"all"===a._config.groupById?this._config.groups=[{key:"all",values:this._data,x:this.center.x,y:this.center.y}]:this._data&&"color"===a._config.groupById?(this._data.forEach(function(a){return function(b){return b[a._config.groupById]==a._calculate_color_group(b)}}(this)),this._config.groups=d3.nest().key(function(b){return b[a._config.groupById]}).sortKeys(function(a,b){return Number(a)<Number(b)?-1:Number(a)>Number(b)?1:0}).entries(this._data)):this._data&&this._data[0].hasOwnProperty(this._config.groupById)&&(this._config.groups=d3.nest().key(function(b){return b[a._config.groupById]}).sortKeys(d3.ascending).entries(this._data)),this._config.groups=this._config.groups.sort(function(a,b){return b.radius-a.radius});var b="color"===this._config.groupById?this._config.groups.length:this._config.lanes,c=this._config.groups.length>b?b:this._config.groups.length,d=.9*this._config.width/c,e=this._config.height/Math.ceil(this._config.groups.length/c)-2;this._config.maxRadius=e-3,this.radius_scale.range([this._config.minRadius,this._config.maxRadius]),this._config.groups&&this._config.groups.forEach(function(a){return function(a,b){var f=Math.floor(b/c);a.x=d*(b%c),a.y=f*e,a.dx=d,a.dy=e,a.cx=a.x+a.dx/2,a.cy=a.y+a.dy/2}}(this))},GravityBubbles.prototype._calculate_boundary=function(a){var b=0;return a.forEach(function(a){return function(c){var d=a._radius_by(c),e=Math.PI*Math.pow(d,2);b+=e}}(this)),Math.sqrt(b/Math.PI)},GravityBubbles.prototype.data=function(a){this._data=a;var b=this;return this._data&&0!==this._data.length?(this.svg.selectAll(".selected").classed("selected",!1),this.min_amount=d3.min(this._data,function(a){return Number(a[b._config.sizeById])}),this.max_amount=d3.max(this._data,function(a){return Number(a[b._config.sizeById])}),this.radius_scale.domain([this.min_amount,this.max_amount]).range([this._config.minRadius,this._config.maxRadius]),this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount],this.create_nodes(),this._calculate_groups(),this.force=d3.layout.force().nodes(this.nodes).size([this._config.width,this._config.height]),this.force.gravity(function(a){return function(b){return a.layout_gravity}}(this)).charge(function(a){return function(b,c){var d=(b[a._config.groupById]?b[a._config.groupById]:"all",a._radius_by(b));return-Math.pow(d,2)/7}}(this)).friction(.9).alpha(.1).on("tick",function(a){return function(b){return a.circles.each(a.move_towards_center(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}}(this)),this.refresh(),void this.force.start()):void(this.nodes=[])},GravityBubbles.prototype.move_towards_center=function(a){return function(b){return function(c){var d="undefined"==typeof b._config.groupById||"all"===b._config.groupById?"all":c[b._config.groupById],e=b._get_group(d);return c.x=c.x+(e.cx-c.x)*(b.damper+.02)*a*1.1,c.y=c.y+(e.cy-c.y)*(b.damper+.02)*a*1.1,c.y}}(this)},GravityBubbles.prototype._get_group=function(a){var b={};return this._config.groups.forEach(function(c){var d=""+c.key,e=""+a;d===e&&(b=c)}),b},GravityBubbles.prototype.create_nodes=function(){var a=this;return this.nodes=[],this._data.forEach(function(a){return function(b){return a.nodes.push(b)}}(this)),this.nodes.sort(function(b,c){return c[a._config.sizeById]-b[a._config.sizeById]})},GravityBubbles.prototype._draw_groups=function(){var a=this.svg.selectAll("#groups_layer"),b=a.selectAll(".group").data(this._config.groups);b.enter().append("rect").attr("class","group").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.dx}).attr("height",function(a){return a.dy}),b.classed("multiple",function(a){return"all"==a.key?!1:!0}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.dx}).attr("height",function(a){return a.dy}),b.exit().remove();var c=this.svg.selectAll("#groups_title_layer"),d=c.selectAll(".group-text").data(this._config.groups);d.enter().append("text").attr("class","group-text").call(this._draw_group_text,this).call(this._draw_group_position,this),d.call(this._draw_group_text,this).call(this._draw_group_position,this),d.exit().remove()},GravityBubbles.prototype._draw_group_text=function(a,b){return"all"===b._config.groupById?void this.text(""):"color"===b._config.groupById?void this.text(function(a){return"more"===a.key?">= "+b._config.points[b._config.points.length-1]:"< "+a.key}):void(b._config.data.group&&b._config.data.group.label&&"function"==typeof b._config.data.group.label&&this.text(function(a){return b._config.data.group.label.call(b,a,b)}))},GravityBubbles.prototype._draw_group_position=function(a,b){this.attr("x",function(a){if("all"!=b._config.groupById&&"color"!=b._config.groupById&&this.getComputedTextLength()>a.dx){var c=this.innerHTML.split("-");this.innerHTML=c[0]}return a.x+a.dx/2-this.getComputedTextLength()/2}).attr("y",function(a){return a.y+15})},GravityBubbles.prototype._update_radius=function(){this.radius_scale.domain([this.min_amount,this.max_amount]).range([this._config.minRadius,this._config.maxRadius])},GravityBubbles.prototype.refresh=function(){if(this._data&&0!==this._data.length){if("all"===this._config.groupById){var a=this._calculate_boundary(this._data),b=this._config.height/2*this._config.maxRadius/a;this._config.maxRadius=.8*b}else this._config.maxRadius=25;this._draw_groups(),this._update_radius(),this._draw_circles(),this._draw_centers(),this._draw_legends()}},GravityBubbles.prototype._draw_centers=function(){if(this._config.debug){var a=this.svg.selectAll(".centros").data(this._config.groups);a.enter().append("circle").attr("class","centros").attr("r",function(a){return 5}).attr("fill","#000").attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}),a.attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}),a.exit().remove()}},GravityBubbles.prototype._center=function(){this.center.x=.75*this._config.width/2,this.center.y=this._config.height/2},GravityBubbles.prototype._draw_legends=function(){if(this._data&&0!==this._data.length){var a=this.svg.selectAll("#legend_layer");this.legends=a.selectAll(".legend-circle").data(this.legend_scale),this.legends.enter().append("circle").attr("class","legend-circle").attr("r",function(a){return function(b){return a.radius_scale(b)}}(this)).attr("cx",function(a){return function(b){return a._config.width-a.radius_scale(a.legend_scale[2])-a.margin.right}}(this)).attr("cy",function(a){return function(b){return a._config.height-a.radius_scale(b)-a.margin.bottom}}(this)),this.legends.transition().duration(1e3).attr("r",function(a){return function(b){return a.radius_scale(b)}}(this)).attr("cx",function(a){return function(b){return a._config.width-a.radius_scale(a.legend_scale[2])-a.margin.right}}(this)).attr("cy",function(a){return function(b){return a._config.height-a.radius_scale(b)-a.margin.bottom}}(this)),this.legends.exit().remove(),this.legends_texts=a.selectAll(".legend-text").data(this.legend_scale),this.legends_texts.enter().append("text").attr("class","legend-text").call(this._legend_text,this).call(this._legend_text_position,this),this.legends_texts.call(this._legend_text,this).call(this._legend_text_position,this)}},GravityBubbles.prototype._legend_text=function(a,b){this.text(function(a){return b._config.legend&&b._config.legend.format?b._config.legend.format.call(this,a):void 0})},GravityBubbles.prototype._legend_text_position=function(a,b){this.transition().attr("x",function(a){var c=this.getComputedTextLength();return b._config.width-b.radius_scale(b.legend_scale[2])-c/2-b.margin.right}).attr("y",function(a){return b._config.height-(2*b.radius_scale(a)+b.margin.bottom+5)})},GravityBubbles.prototype._draw_circles=function(){var a=this.svg.select("#bubbles_layer");this.circles=a.selectAll(".bubble").data(this.nodes);var b=this;this.circles.enter().append("circle").attr("class","bubble").attr("stroke",function(a){return d3.rgb(b._fill_color_by(a)).darker()}).attr("fill",function(a){return b._fill_color_by(a)}).attr("r",function(a){return 0}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).on("mouseover",function(a,c){return b.show_details(a,c,b)}).on("mouseout",function(a,c){return b.hide_details(a,c,b)}).on("click",function(a,c){b.hide_details(a,c,b),d3.select(this).classed("selected",function(a,b){return!d3.select(this).classed("selected")}),b._config.data.onclick.call(b,a,c)}),this.circles.transition().attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),this.circles.transition().duration(1e3).ease("ease-in-out").attr("r",function(a){return b._radius_by(a)}).attr("stroke",function(a){return d3.rgb(b._fill_color_by(a)).darker()}).attr("fill",function(a){return b._fill_color_by(a)}).text(function(a){return a.weight}),this.circles.exit().remove()},GravityBubbles.prototype._update_colors=function(){this.fill_color=d3.scale.linear().domain(this._config.points).range(this._config.colors),this.color_layer=d3.scale.linear().domain(this._config.points).range([0,this._config.height/4,this._config.height/2,this._config.height/4+this._config.height/2,this._config.height]),this.nodes.forEach(function(a){return function(b){b.weight=a.color_layer(Number(b[a._config.colorById]))}}(this)),this.force&&this.force.start()},GravityBubbles.prototype._fill_color_by=function(a){return a.hasOwnProperty(this._config.colorById)&&!isNaN(a[this._config.colorById])?this.fill_color(a[this._config.colorById]):0},GravityBubbles.prototype._radius_by=function(a){return a.hasOwnProperty(this._config.sizeById)&&!isNaN(a[this._config.sizeById])?this.radius_scale(a[this._config.sizeById]):0},GravityBubbles.prototype.resize=function(){this.config({width:parseInt(this.container.style("width")),height:parseInt(this.container.style("height"))});this._data&&this._data.length>0&&(this._calculate_groups(),this.refresh(),this.force.start())},gravity-bubbles});